<link rel="import" href="/sys/moment-element/moment-element.html">
<!--<link rel="stylesheet" href="/sys/Stylesheet1.css">-->

<template>
    <template is="dom-bind" id="tmpOphs">
        <!--<div>[[processInit(model.Html)]]</div>-->
        <div>[[processInit(model.Html)]]</div>

        <!--
		    <div style="width:100%;overflow:hidden;box-sizing:border-box">
		    <table  id="tblOphs" style="table-layout:fixed;font-family:Arial, Helvetica, sans-serif;font-size:small" onclick="tmplt.MyFnc(event, this)">
		    <table id="tblOphs" style="table-layout:auto;font-family:Arial, Helvetica, sans-serif;font-size:small" on-click="MyFnc"  dene="[[processInit(model.Html)]]">
            <table id="tblOphs" style="table-layout:auto;font-family:Arial, Helvetica, sans-serif;font-size:small" on-click="MyFnc">
            <table id="tblOphs" style="table-layout:fixed;font-size:small; width:100%" on-click="MyFnc">
            <div style="height: calc(100vh - 76px); width: 100vw; overflow: auto;">
        <div style="max-height: calc(100vh - 76px); width: calc(100vw - 4px); overflow: auto;">
        <div class="oph-table">
            <table id="tblOphs" style="font-size:small;" on-click="MyFnc">
        -->
        
        <div class="oph-table">
            <table id="tblOphs" on-click="MyFnc">
                <!--<table id="tblOphs" class="print t1" on-click="MyFnc">-->
                <caption>
                    <input type="button" data-link="/tMax14web/ophs2xlsx/[[model.fID]]/[[model.StartDate]]" on-tap="MyDownload" value="Download Excel" />
                    <!--<input type="button" data-link="ophs2xlsx/[[model.fID]]/[[model.StartDate]]" on-tap="MyDownload" value="Download Excel" /> Bu da calisiyor-->
                </caption>
                <thead>
                    <tr>
                        <th id="OphID" data-tooltip$="[[model.OphID]]">ID</th>
                        <th id="EXD_t" data-tooltip$="[[model.EXD_t]]">EXD</th>
                        <th id="RefNo" data-tooltip$="[[model.RefNo]]">EXD</th>
                        <th id="Vhc" data-tooltip$="[[model.Vhc]]">Vehicle</th>

                        <th id="ROT" data-tooltip$="[[model.ROT]]">R</th>
                        <th id="MOT" data-tooltip$="[[model.MOT]]">M</th>

                        <th id="Org" data-tooltip$="[[model.Org]]">Org</th>
                        <th id="Dst" data-tooltip$="[[model.Dst]]">Dst</th>

                        <th id="nStu" data-tooltip$="[[model.nStu]]">Statu</th>
                        <th id="nStuTS_t" data-tooltip$="[[model.nStuTS_t]]"></th>
                        <th id="pStu" data-tooltip$="[[model.pStu]]">Problem</th>
                        <th id="pStuTS_t" data-tooltip$="[[model.pStuTS_t]]"></th>

                        <th id="ShpAd" data-tooltip$="[[model.ShpAd]]">Shp</th>
                        <th id="CneAd" data-tooltip$="[[model.CneAd]]">Cne</th>
                        <th id="AccAd" data-tooltip$="[[model.AccAd]]">Acc</th>
                        <th id="MnfAd" data-tooltip$="[[model.MnfAd]]">Mnf</th>
                        <th id="NfyAd" data-tooltip$="[[model.NfyAd]]">Ntf</th>

                        <th id="NOP" data-tooltip$="[[model.NOP]]">NOP</th>
                        <th id="GrW" data-tooltip$="[[model.GrW]]">GrW</th>
                        <th id="VM3" data-tooltip$="[[model.VM3]]">VM3</th>
                        <th id="ChW" data-tooltip$="[[model.ChW]]">ChW</th>

                        <th id="DTM" data-tooltip$="[[model.DTM]]">DTM</th>
                        <th id="PTM" data-tooltip$="[[model.PTM]]">PTM</th>

                        <th id="ROH_t" data-tooltip$="[[model.ROH_t]]">ROH</th>
                        <th id="EOH_t" data-tooltip$="[[model.EOH_t]]">EOH</th>
                        <th id="REOH_t" data-tooltip$="[[model.REOH_t]]">REOH</th>
                        <th id="AOH_t" data-tooltip$="[[model.AOH_t]]">AOH</th>
                        <th id="RTR_t" data-tooltip$="[[model.RTR_t]]">RTR</th>
                        <th id="ROS_t" data-tooltip$="[[model.ROS_t]]">ROS</th>
                        <th id="POD_t" data-tooltip$="[[model.POD_t]]">POD</th>

                        <th id="ETD_t" data-tooltip$="[[model.ETD_t]]">ETD</th>
                        <th id="ATD_t" data-tooltip$="[[model.ATD_t]]">ATD</th>
                        <th id="ETA_t" data-tooltip$="[[model.ETA_t]]">ETA</th>
                        <th id="ATA_t" data-tooltip$="[[model.ATA_t]]">ATA</th>

                        <th id="ACOT_t" data-tooltip$="[[model.ACOT_t]]">ACOT</th>
                        <th id="DRBD_t" data-tooltip$="[[model.DRBD_t]]">DRBD</th>
                        <th id="TPAD_t" data-tooltip$="[[model.TPAD_t]]">TPAD</th>
                        <th id="TPDD_t" data-tooltip$="[[model.TPDD_t]]">TPDD</th>

                        <th id="CntNoS" data-tooltip$="[[model.CntNoS]]">Cnt#</th>
                    </tr>
                    <tr>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                        <th><input on-keyup="MyFilter" type="text" class="searchInput" required></th>
                    </tr>
                </thead>
                <tbody>
                    <template is="dom-repeat" items="{{abcd}}">
                        <tr>
                            <td data-typ="nmr">[[item.OphID]]</td>
                            <!--<td style="max-width: 200px;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;">[[item.EXD]]</td>-->
                            <td><moment-element datetime="[[item.EXD_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td>[[item.RefNo]]</td>
                            <td>[[item.Vhc]]</td>
                            <td>[[item.ROT]]</td>
                            <td>[[item.MOT]]</td>
                            <td>[[item.Org]]</td>
                            <td>[[item.Dst]]</td>
                            <td>[[item.nStuAd]]</td>
                            <td class="trh"><moment-element datetime="[[item.nStuTS_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td>[[item.pStu]]</td>
                            <td>[[item.pStuD]]</td>

                            <td data-typ="frm">[[item.ShpAd]]</td>
                            <td data-typ="frm">[[item.CneAd]]</td>
                            <td data-typ="frm">[[item.AccAd]]</td>
                            <td data-typ="frm">[[item.MnfAd]]</td>
                            <td data-typ="frm">[[item.NfyAd]]</td>

                            <td data-typ="nmr">[[item.NOP]]</td>
                            <td data-typ="nmr">[[item.GrW]]</td>
                            <td data-typ="nmr">[[item.VM3]]</td>
                            <td data-typ="nmr">{{item.ChW}}</td>

                            <td>[[item.DTM]]</td>
                            <td>[[item.PTM]]</td>

                            <td data-typ="trh"><moment-element datetime="[[item.ROH_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td data-typ="trh"><moment-element datetime="[[item.EOH_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td data-typ="trh"><moment-element datetime="[[item.REOH_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td data-typ="trh"><moment-element datetime="[[item.AOH_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td data-typ="trh"><moment-element datetime="[[item.RTR_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td data-typ="trh"><moment-element datetime="[[item.ROS_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td data-typ="trh"><moment-element datetime="[[item.POD_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td data-typ="trh"><moment-element datetime="[[item.ETD_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td data-typ="trh"><moment-element datetime="[[item.ATD_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td data-typ="trh"><moment-element datetime="[[item.ETA_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td data-typ="trh"><moment-element datetime="[[item.ATA_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td data-typ="trh"><moment-element datetime="[[item.ACOT_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td data-typ="trh"><moment-element datetime="[[item.DRBD_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td data-typ="trh"><moment-element datetime="[[item.TPAD_t]]" output-format="DD.MM.YY"></moment-element></td>
                            <td data-typ="trh"><moment-element datetime="[[item.TPDD_t]]" output-format="DD.MM.YY"></moment-element></td>

                            <td>[[item.CntNoS]]</td>
                        </tr">
                    </template>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="37">
                            <span> #Rec: [[NOR]]</span>
                        </th>
                    </tr>
                </tfoot>
            </table>
        </div>

</template>
	
	<script>
		(function ()
		{
			var curRowIndex = -1;
			var curCellIndex = -1;

			var script = document._currentScript || document.currentScript;
			tmplt = script.previousElementSibling;

			console.log("Script run");

			tmplt.addEventListener('dom-change', function () {
			    console.log('dom-change');
			});


		    // FF: bu event'i hic gormuyor
			tmplt.ready = function () {
			    console.log('readyyyyyyyyyyyyyyy');
			    //this.processInit("dummy");
			};

		    // Herzaman ready oldugu icin asagidakinin burda hicbir faydasi yok
			document.addEventListener('readystatechange', function () {
			    console.log("document.readyState", document.readyState);
			    if (document.readyState === 'complete') {
			        console.log("document.readyState: complete");
			    }
			});

		    // Chrom'dan baskasinda calismiyor (observers Polymer'den geliyor)
			tmplt.messageChanged = function (newMessageValue) {
			    console.log("Message was changed", newMessageValue);
			};
			tmplt.observers = ["messageChanged(model.sener)"];


		    // FF: Ilk giriste processInit'i gormuyor
			tmplt.abcd = JSON.parse(JSON.stringify(tmplt.model.Ophs));

		    // model degisikliginde calisiyor <div>[[processInit(model.Html)]]</div>
			tmplt.processInit = function (val) {
			    //console.log("processInit this1", this.$.tblOphs);
			    //console.log("processInit this2", this.$["EXD"]);
			    if (curCellIndex != -1) {
			        this.$.tblOphs.rows[0].cells[curCellIndex].classList.remove("curSort");
			    }
			    if (curRowIndex != -1) {
			        this.$.tblOphs.rows[curRowIndex].classList.remove("curRow");
			    }
			    curRowIndex = -1;
			    curCellIndex = -1;
			    //console.log("tmplt", tmplt.model);
			    tmplt.abcd = JSON.parse(JSON.stringify(tmplt.model.Ophs));

			    tmplt.NOR = tmplt.abcd.length
			    console.log("processInit", tmplt.NOR);

			    setTimeout(function () {
			        tmplt.MyFilter();
			    });
			};

			tmplt.MyDownload = function (e) {
			    e.stopImmediatePropagation(); //stopPropagation();
			    window.open(e.target.dataLink, '_self');
			}

			tmplt.MyFnc = function (e) {
			    console.log(e);
			    var tr = e.target.closest("tr");
			    console.log("tr", tr);
			    if (tr == null) // Input Table'da oldugu icin oradan da gelebilit
			        return;

			    if (tr.rowIndex == 0) {     // Sort
			        //console.log("target ID", e.target.id.substring(e.target.id.length - 2));
			        if (curCellIndex != -1) {
			            tblOphs.rows[0].cells[curCellIndex].classList.remove("curSort");
			            //this.$.tblOphs.rows[0].cells[curCellIndex].classList.remove("curSort");
			        }
			        //console.log("TableMyFnc2", this);
			        curCellIndex = e.target.cellIndex;
			        e.target.classList.add("curSort");

			        var sener = JSON.parse(JSON.stringify(tmplt.model.Ophs));
			        //if (e.target.id.substring(e.target.id.length - 2) == "_t")
			        if (e.target.id.endsWith("_t") || e.target.id.endsWith("ID"))
			            tmplt.abcd = sener.sort(firstBy(e.target.id, -1));
			        else
			            tmplt.abcd = sener.sort(firstBy(e.target.id));

			        //console.log("tmplt.model.Ophs1", tmplt.model.Ophs[0].ChW$);
			        //tmplt.model.Ophs[0].ChW$ = 11;
			        //tmplt.model.Ophs.Clear();// = sener.sort(firstBy(e.target.id));
			        //console.log("tmplt.model.Ophs2", tmplt.model.Ophs);

			        if (curRowIndex != -1)
			            tblOphs.rows[curRowIndex].classList.remove("curRow");

			        // Table refresh olduktan sonra MyFilter calismali
			        setTimeout(function () {
			            tmplt.MyFilter();
			        });

			    }
			    else if (tr.rowIndex > 1) {     // Mark current Row
			        if (curRowIndex != -1) {
			            tblOphs.rows[curRowIndex].classList.remove("curRow"); //this.$.tblOphs.rows[curRowIndex].classList.remove("curRow");
			        }
			        //console.log("e.target", e);
			        //var curTr = e.target.closest("tr");
			        //console.log("e.target.closest(tr)", curTr.rowIndex);

			        curRowIndex = tr.rowIndex; //curTr.rowIndex;
			        tr.classList.add("curRow"); //curTr.classList.add("curRow");

			        //curRowIndex = e.target.parentNode.rowIndex;
			        //e.target.parentNode.classList.add("curRow");

			        //console.log("curRowIndex", curRowIndex);
			    }
			}

			tmplt.MyFilter = function (e) {
			    var nor = tblOphs.rows.length - 1;  // Footer'i sayma
			    var noc = tblOphs.rows[0].cells.length;
			    //var tbl = document.querySelector('#tblOphs');
			    //console.log('NOR', nor, 'NOC', noc);
			    var fnor = 0;   // Filtered NOR

                // Search values
			    var svs = tblOphs.querySelectorAll('thead tr input');
			    //console.log(svs);
			    var sva = [];
			    for (var j = 0; j < svs.length; j++) {
			        sva.push(svs[j].value);

			    }
			    //console.log(sva);

			    var sv, cv;
			    for (var i = 2; i < nor; i++) {     // Header'i gec
			        var show = sva.every(function (input, index) {
			            if (input === '') {
			                return true;
			            }

			            if (tblOphs.rows[i].cells[index].childElementCount == 0)
			                cv = tblOphs.rows[i].cells[index].innerText;
			            else
			                cv = tblOphs.rows[i].cells[index].firstChild.__data__.output;   // moment-element'in koydugu deger

			            return cv.indexOf(input) != -1;
			        });

			        if (show) {
			            tblOphs.rows[i].style.display = '';
			            fnor++;
			        }
			        else
			            tblOphs.rows[i].style.display = 'none';
			    }
			    tmplt.NOR = fnor;
			}


            /*
			console.log('init-start');
			if (curCellIndex != -1) {
			    this.$.tblOphs.rows[0].cells[curCellIndex].classList.remove("curSort");
			}
			if (curRowIndex != -1) {
			    this.$.tblOphs.rows[curRowIndex].classList.remove("curRow");
			}
			curRowIndex = -1;
			curCellIndex = -1;
			tmplt.abcd = JSON.parse(JSON.stringify(tmplt.model.Ophs));
			console.log("init-end arrayLength", tmplt.abcd.length);
            */
		    /*
			tmplt.ready = function () {
			    console.log('ready');
			    if (curCellIndex != -1) {
			        this.$.tblOphs.rows[0].cells[curCellIndex].classList.remove("curSort");
			    }
			    if (curRowIndex != -1) {
			        this.$.tblOphs.rows[curRowIndex].classList.remove("curRow");
			    }
			    curRowIndex = -1;
			    curCellIndex = -1;
			    tmplt.abcd = JSON.parse(JSON.stringify(tmplt.model.Ophs));
			    console.log("processInit", tmplt.abcd.length);
			}*/
            
            /*
			tmplt.MyFilter2 = function (e) {
			    console.log(e);
			    var suche = e.target.value; //.toLowerCase();
			    console.log("suche", e.target.value);
			    //suche = e.target.parentNode.cellIndex;
			    var table = document.getElementById('tblOphs');
			    var ele;
			    for (var r = 2; r < table.rows.length; r++) {
			        if (table.rows[r].style.display != 'none') {
			            //ele = table.rows[r].cells[e.target.parentNode.cellIndex].innerHTML.replace(/<[^>]+>/g, "");
			            //console.log("ele", table.rows[r].cells[e.target.parentNode.cellIndex].firstChild);
			            //console.log("ele", table.rows[r].cells[e.target.parentNode.cellIndex].firstChild.__data__.output);
			            if (table.rows[r].cells[e.target.parentNode.cellIndex].childElementCount == 0)
			                ele = table.rows[r].cells[e.target.parentNode.cellIndex].innerHTML;
			            else
			                ele = table.rows[r].cells[e.target.parentNode.cellIndex].firstChild.__data__.output;

			            if (ele.indexOf(suche) >= 0)
			                table.rows[r].style.display = '';
			            else table.rows[r].style.display = 'none';
			        }
			    }
			}
            */
            /*
			tmplt.MyFnc2 = function (e) {
			    console.log("e.target", e.target.closest("tr"));
			    if (e.target.parentNode.rowIndex == 0) {
			        console.log("target ID", e.target.id.substring(e.target.id.length - 2));
			        if (curCellIndex != -1) {
			            this.$.tblOphs.rows[0].cells[curCellIndex].classList.remove("curSort");
			            //x.rows[0].cells[curCellIndex].classList.remove("curSort");
			        }
			        //console.log("TableMyFnc2", this);
			        curCellIndex = e.target.cellIndex;
			        e.target.classList.add("curSort");

			        var sener = JSON.parse(JSON.stringify(tmplt.model.Ophs));
			        //if (e.target.id.substring(e.target.id.length - 2) == "_t")
			        if (e.target.id.endsWith("_t") || e.target.id.endsWith("ID"))
			            tmplt.abcd = sener.sort(firstBy(e.target.id, -1));
			        else
			            tmplt.abcd = sener.sort(firstBy(e.target.id));

			        //console.log("tmplt.model.Ophs1", tmplt.model.Ophs[0].ChW$);
			        //tmplt.model.Ophs[0].ChW$ = 11;
			        //tmplt.model.Ophs.Clear();// = sener.sort(firstBy(e.target.id));
			        //console.log("tmplt.model.Ophs2", tmplt.model.Ophs);
			    }
			    else if (e.target.parentNode.rowIndex > 1) {
			        if (curRowIndex != -1) {
			            this.$.tblOphs.rows[curRowIndex].classList.remove("curRow");
			        }
			        console.log("e.target", e);
			        var curTr = e.target.closest("tr");
			        console.log("e.target.closest(tr)", curTr.rowIndex);

			        curRowIndex = curTr.rowIndex;
			        curTr.classList.add("curRow");

			        //curRowIndex = e.target.parentNode.rowIndex;
			        //e.target.parentNode.classList.add("curRow");

			        console.log("curRowIndex", curRowIndex);
			    }
			}
            */
		})();

	</script>

</template>
